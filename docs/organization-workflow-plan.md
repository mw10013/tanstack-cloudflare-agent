# OrganizationWorkflow Plan

## Summary

Add an `AgentWorkflow` with human approval to `OrganizationAgent`. No AI — just durable steps that convey state, pause for approval, and resume. Demonstrates the full `Agent + AgentWorkflow` pattern.

## Architecture

```
Client (route) ──WebSocket──▶ OrganizationAgent ──runWorkflow──▶ OrganizationWorkflow
                                   │                                    │
                                   ◀──── onWorkflowProgress/Complete ───┘
                                   │
                              broadcast()
                                   │
                              ◀────┘ (real-time UI updates)
```

- Client never talks to workflow directly
- Agent is the intermediary: owns WebSocket, tracks workflows in SQLite, receives callbacks
- Workflow communicates back to agent via `reportProgress`, `broadcastToClients`, `step.reportComplete`

## Workflow Steps

1. `step.do("prepare-request")` — returns `{ title, requestedAt }`
2. `reportProgress({ status: "pending" })` — non-durable, broadcasts to clients
3. `waitForApproval(step, { timeout: "7 days" })` — hibernates until approve/reject
4. **Approved**: `step.do("finalize")` → `step.reportComplete(result)`
5. **Rejected**: `reportProgress({ status: "rejected" })` → error state (SDK default from `waitForApproval`)

## Workflow ID Generation

Workflow IDs are generated by `Agent.runWorkflow()`:

- **Default**: `nanoid()` — random unique string, auto-generated if no ID provided
- **Optional**: pass a custom ID via `options.id` for deterministic/meaningful IDs
- **Must be unique**: duplicate IDs throw `UNIQUE constraint failed` on insert into `cf_agents_workflows`

The returned `workflowId` is the key that links everything: the Cloudflare Workflow instance, the agent's SQLite tracking table row, and the client UI. It's what gets passed to `approveWorkflow(workflowId)`, `rejectWorkflow(workflowId)`, and displayed in the UI.

## Kickoff Flow

1. User clicks "Start Workflow" button in route UI
2. Button calls `agent.stub.requestApproval(title, description)` — RPC over WebSocket
3. Agent calls `this.runWorkflow("OrganizationWorkflow", payload, { metadata: { title, description } })`
4. Cloudflare creates workflow instance, invokes `OrganizationWorkflow.run()`

Approve/reject follows the same pattern: client calls `agent.stub.approveRequest(workflowId)`, agent calls `this.approveWorkflow(workflowId, ...)`, which sends an event that resumes the hibernating `waitForApproval` step.

## Key Decisions

| Decision | Choice | Rationale |
|---|---|---|
| Binding name | `"OrganizationWorkflow"` (matches class name) | Avoids name/binding mismatch — the #1 gotcha when calling `runWorkflow()` |
| Rejected semantics | errored/terminated (SDK default) | `waitForApproval` calls `step.reportError` on reject. UI maps `errored\|terminated → rejected`. Matches playground pattern |
| Metadata | title/description stored in workflow metadata | `runWorkflow(..., { metadata: { title, description } })` makes `getWorkflows()` self-sufficient, no extra tables |
| UI updates | Initial fetch + WebSocket broadcasts | Canonical state from `listApprovalRequests()`, real-time hints from broadcasts, keyed by workflowId for idempotency |
| File organization | Co-located in `organization-agent.ts` | `OrganizationWorkflow` class above `OrganizationAgent`. No circular imports. Separation is stylistic |
| Approval timeout | 7 days | Playground default, reasonable for demo |

## Files to Change

### `src/organization-agent.ts`

Add `OrganizationWorkflow` class (above `OrganizationAgent`):

```ts
export class OrganizationWorkflow extends AgentWorkflow<
  OrganizationAgent,
  { title: string; description: string },
  { status: "pending" | "approved" | "rejected"; message: string }
> {
  async run(event, step) {
    const { title } = event.payload;

    const request = await step.do("prepare-request", async () => ({
      title,
      requestedAt: Date.now(),
    }));

    await this.reportProgress({ status: "pending", message: `Requested: ${title}` });

    try {
      const approvalData = await this.waitForApproval<{ approvedBy?: string }>(step, {
        timeout: "7 days",
      });

      const result = { approved: true, title: request.title, resolvedAt: new Date().toISOString(), approvalData };
      await this.reportProgress({ status: "approved", message: `Approved: ${title}` });
      await step.reportComplete(result);
      return result;
    } catch (_error) {
      await this.reportProgress({ status: "rejected", message: `Rejected: ${title}` });
      return { approved: false, title: request.title, resolvedAt: new Date().toISOString() };
    }
  }
}
```

Add to `OrganizationAgent`:

- `onWorkflowProgress(name, id, progress)` — broadcasts to connected clients
- `onWorkflowComplete(name, id, result)` — broadcasts to connected clients
- `onWorkflowError(name, id, error)` — broadcasts to connected clients
- `@callable requestApproval(title, description)` — calls `this.runWorkflow("OrganizationWorkflow", ...)`
- `@callable approveRequest(workflowId)` — calls `this.approveWorkflow(workflowId, ...)`
- `@callable rejectRequest(workflowId, reason?)` — calls `this.rejectWorkflow(workflowId, ...)`
- `@callable listApprovalRequests()` — calls `this.getWorkflows({ workflowName: "OrganizationWorkflow" })`

### `wrangler.jsonc`

Add `"workflows"` array (both local and production env):

```jsonc
"workflows": [
  {
    "name": "OrganizationWorkflow",
    "binding": "OrganizationWorkflow",
    "class_name": "OrganizationWorkflow"
  }
]
```

### `src/worker.ts`

Add export:

```ts
export { OrganizationWorkflow } from "./organization-agent";
```

### `src/routes/app.$organizationId.workflow.tsx` (new)

Route at same level as chat and agent. Uses `useAgent` to connect to `OrganizationAgent`.

- **Start workflow**: input for title/description, button calls `agent.stub.requestApproval(title, description)`
- **List workflows**: initial fetch via `agent.stub.listApprovalRequests()`, live updates via WebSocket `agent.on("message", ...)` keyed by workflowId
- **Approve/Reject**: buttons on pending items call `agent.stub.approveRequest(id)` / `agent.stub.rejectRequest(id, reason)`
- **Status badges**: pending (yellow), approved (green), rejected (red)

### `src/routes/app.$organizationId.tsx`

Add "Workflow" sidebar link between "Chat" and "Inspector".

## Reference Examples

- Agent-side: `refs/agents/examples/playground/src/demos/workflow/approval-agent.ts`
- Workflow-side: `refs/agents/examples/playground/src/demos/workflow/approval-workflow.ts`
- Wrangler config: `refs/agents/examples/playground/wrangler.jsonc` (workflows array at line 32)
- AgentWorkflow base: `refs/agents/packages/agents/src/workflows.ts`
