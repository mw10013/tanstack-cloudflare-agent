# R2 Presigned Thumbnail Upload Plan

## Goal

Update `src/routes/app.$organizationId.upload.tsx` to:

- accept images only
- validate upload name with `a-zA-Z`, `_`, `-` only
- display uploaded files as image thumbnails
- use R2 presigned URLs (via `aws4fetch`) for image display access
- improve layout so upload form and messages sit side-by-side

No Cloudflare Images service usage.

## Decisions (locked)

- image MIME allowlist: `image/png`, `image/jpeg`, `image/webp`, `image/gif`
- signed URL TTL: `900` seconds (15 minutes)
- local development: use proxy path, not presigned URLs
- same name behavior: keep overwrite semantics (last write wins)
- image rendering: native `<img>`
- loader payload: no `thumbnailExpiresAt` field

## Answers To Annotated Questions

### What are the "S3" keys if we do not use AWS?

They are **Cloudflare R2 API credentials**, not AWS account credentials.

Where to get them:

1. Cloudflare Dashboard -> R2 -> Manage R2 API Tokens
2. Create token with bucket-scoped permissions (`Object Read` is enough for GET signing)
3. Save generated:
   - Access Key ID -> `R2_S3_ACCESS_KEY_ID`
   - Secret Access Key -> `R2_S3_SECRET_ACCESS_KEY`

Rationale: Cloudflare R2 uses an S3-compatible API + SigV4 signing model for presigned URLs.

### Is CORS really required?

Per Cloudflare docs (`refs/cloudflare-docs/src/content/docs/r2/buckets/cors.mdx`): browser-based presigned URL use needs CORS.

Practical nuance:

- plain `<img src="...">` may still render without JS reading response headers/body
- any `fetch`/XHR usage and reliable cross-origin browser behavior should assume CORS is required
- plan keeps CORS configuration as required infra step for robustness

### Do we need `thumbnailExpiresAt`?

No. Removed.

- URLs are refreshed on route reload/invalidate
- UI does not need to compute exact expiry timestamp

### Should DO or server fn generate `thumbnailUrl`?

Server fn/loader should generate it.

Why:

- presigned URLs are request-scoped view data, not durable state
- avoids persisting expiring URLs in DO storage
- keeps DO focused on stable metadata (`name`, `createdAt`)
- keeps signing credentials usage in route/server layer

## Docs Grounding

Cloudflare refs used:

- `refs/cloudflare-docs/src/content/docs/r2/api/s3/presigned-urls.mdx`
- `refs/cloudflare-docs/src/content/docs/r2/examples/aws/aws4fetch.mdx`
- `refs/cloudflare-docs/src/content/docs/r2/examples/aws/aws-sdk-js-v3.mdx`
- `refs/cloudflare-docs/src/content/docs/r2/get-started/workers-api.mdx`
- `refs/cloudflare-docs/src/content/docs/r2/buckets/cors.mdx`

## Current System Notes

From code:

- `src/routes/app.$organizationId.upload.tsx` currently accepts PNG/JPEG/PDF
- `src/worker.ts` queue consumer reads `customMetadata.organizationId` + `customMetadata.name` then calls `stub.onUpload({ name })`
- `src/organization-agent.ts` stores uploads as `Upload(name, createdAt)`

Constraint:

- keep existing `customMetadata.organizationId` and `customMetadata.name` unchanged

## File-by-File Change Plan

1. `package.json`
- add direct dependency: `aws4fetch` pinned to latest stable from `pnpm view aws4fetch version`
- add script `refs:aws4fetch` to download aws4fetch source under `refs/aws4fetch`

2. `.env.example`
- add `R2_S3_ACCESS_KEY_ID`
- add `R2_S3_SECRET_ACCESS_KEY`
- add `R2_BUCKET_NAME=uploads`

3. `wrangler.jsonc`
- add `R2_BUCKET_NAME` in local + production `vars`
- do not commit real key values; use placeholders/empty values

4. `src/routes/app.$organizationId.upload.tsx`
- update client + server validators:
  - remove PDF
  - regex `^[A-Za-z_-]+$`
- add helper to map uploads to thumbnail URL:
  - local: proxy URL
  - non-local: presigned GET URL via `aws4fetch`
- update loader return shape to include `thumbnailUrl`
- render thumbnail gallery UI with `<img>`
- refactor layout to two-column top section (form + messages)

5. `src/routes/api/...` (new route)
- add local-only proxy endpoint for image bytes
- enforce session + org authorization
- read from `env.R2.get(key)` and return bytes + content type

6. `worker-configuration.d.ts`
- regenerated by `pnpm typecheck` (do not edit manually)

## Data Contracts

### Existing DO contract (unchanged)

`stub.getUploads()` returns:

- `Array<{ name: string; createdAt: number }>`

### Upload route loader contract (updated)

returns:

- `Array<{ name: string; createdAt: number; thumbnailUrl: string }>`

## URL Generation Strategy

### Non-local

- `AwsClient({ service: "s3", region: "auto", accessKeyId, secretAccessKey })`
- sign request URL:
  - `https://${env.CF_ACCOUNT_ID}.r2.cloudflarestorage.com/${env.R2_BUCKET_NAME}/${organizationId}/${name}?X-Amz-Expires=900`
- use `aws: { signQuery: true }`

### Local

- return internal app route URL:
  - `/api/org/${organizationId}/upload-image/${encodeURIComponent(name)}`
- proxy endpoint returns `env.R2.get(${organizationId}/${name})`

## Edge Cases + Handling

- upload name collision: keep current overwrite behavior
- expired presigned URL while page open: user refresh/invalidate regenerates links
- object missing from R2 but present in DO list: image shows fallback placeholder; keep row visible
- unsupported file chosen: blocked by file input `accept` + schema validation
- org mismatch access attempt on proxy route: return `403`

## CORS Checklist (non-local)

R2 bucket CORS policy should include:

- `AllowedOrigins`: app origin(s)
- `AllowedMethods`: `GET` (and optionally `HEAD`)
- `AllowedHeaders`: minimal set

## Implementation Steps

1. Add `aws4fetch` direct dep and `refs:aws4fetch` script.
2. Add signing env vars to `.env.example` and `wrangler.jsonc`.
3. Update upload validation + UI copy in `src/routes/app.$organizationId.upload.tsx`.
4. Add URL enrichment logic in upload loader server fn.
5. Add local image proxy route with auth guard.
6. Replace uploads list with thumbnail gallery.
7. Refactor form/messages layout side-by-side on desktop.
8. Run `pnpm typecheck` and `pnpm lint`.

## Acceptance Criteria

- PDF selection/upload rejected
- invalid names (`a b`, `a/b`, `foo.png`) rejected
- valid names (`avatar_main`, `team-photo`) accepted
- uploads display as thumbnails
- desktop shows form/messages side-by-side
- local env thumbnails work with proxy route
- non-local env thumbnails resolve via presigned GET URLs

## Out of Scope

- Cloudflare Images transforms
- generated thumbnail derivatives pipeline
- object lifecycle cleanup automation
